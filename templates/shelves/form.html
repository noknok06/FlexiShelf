{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ form_title }} - FlexiShelf{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{% url 'shelves:list' %}">棚管理</a></li>
        {% if object %}
            <li class="breadcrumb-item"><a href="{% url 'shelves:detail' object.pk %}">{{ object.name }}</a></li>
            <li class="breadcrumb-item active">編集</li>
        {% else %}
            <li class="breadcrumb-item active">新規作成</li>
        {% endif %}
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    {% if object %}
                        <i class="bi bi-pencil"></i> {{ form_title }}
                    {% else %}
                        <i class="bi bi-plus-lg"></i> {{ form_title }}
                    {% endif %}
                </h4>
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- エラー表示 -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="row g-4">
                        <!-- 基本情報 -->
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> 基本情報
                            </h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label required">
                                    {{ form.name.label }}
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.location.id_for_label }}" class="form-label">
                                    {{ form.location.label }}
                                </label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.location.errors.0 }}
                                    </div>
                                {% endif %}
                                {% if form.location.help_text %}
                                    <div class="form-text">{{ form.location.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.width.id_for_label }}" class="form-label required">
                                    {{ form.width.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.width }}
                                    <span class="input-group-text">cm</span>
                                </div>
                                {% if form.width.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.width.errors.0 }}
                                    </div>
                                {% endif %}
                                {% if form.width.help_text %}
                                    <div class="form-text">{{ form.width.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.depth.id_for_label }}" class="form-label required">
                                    {{ form.depth.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.depth }}
                                    <span class="input-group-text">cm</span>
                                </div>
                                {% if form.depth.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.depth.errors.0 }}
                                    </div>
                                {% endif %}
                                {% if form.depth.help_text %}
                                    <div class="form-text">{{ form.depth.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    {{ form.description.label }}
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.description.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 段設定 -->
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-layers"></i> 段設定
                            </h5>
                        </div>
                        
                        <div class="col-12">
                            <div class="row">
                                <!-- 段管理パネル -->
                                <div class="col-lg-6">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>段構成</span>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary" onclick="addSegment()">
                                                    <i class="bi bi-plus"></i> 追加
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="resetSegments()">
                                                    <i class="bi bi-arrow-clockwise"></i> リセット
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="segment-formset">
                                                {{ segment_formset.management_form }}
                                                
                                                <div id="segment-forms">
                                                    {% for form in segment_formset %}
                                                        <div class="segment-form mb-3" data-form-index="{{ forloop.counter0 }}">
                                                            {% if form.non_field_errors %}
                                                                <div class="alert alert-danger alert-sm">
                                                                    {{ form.non_field_errors }}
                                                                </div>
                                                            {% endif %}
                                                            
                                                            <div class="row g-2 align-items-center">
                                                                <div class="col-auto">
                                                                    <strong>段{{ forloop.counter }}</strong>
                                                                    {{ form.level }}
                                                                </div>
                                                                <div class="col">
                                                                    <div class="input-group input-group-sm">
                                                                        <span class="input-group-text">高さ</span>
                                                                        {{ form.height }}
                                                                        <span class="input-group-text">cm</span>
                                                                    </div>
                                                                    {% if form.height.errors %}
                                                                        <small class="text-danger">{{ form.height.errors.0 }}</small>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="col-auto">
                                                                    {% if form.DELETE %}
                                                                        {{ form.DELETE }}
                                                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                                onclick="toggleDelete(this)" title="削除">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    {% else %}
                                                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                                onclick="removeSegment(this)" title="削除">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- 非表示フィールド -->
                                                            {% for hidden in form.hidden_fields %}
                                                                {{ hidden }}
                                                            {% endfor %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <small class="text-muted">
                                                    <i class="bi bi-info-circle"></i> 
                                                    段番号は自動的に割り当てられます（1=最下段）
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- プレビューパネル -->
                                <div class="col-lg-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <span>プレビュー</span>
                                        </div>
                                        <div class="card-body">
                                            <div id="shelf-preview" class="shelf-preview-container">
                                                <div class="shelf-preview-dimensions">
                                                    <span id="preview-width">-</span>×<span id="preview-depth">-</span>cm
                                                </div>
                                                <div id="shelf-segments-preview" class="shelf-segments-preview">
                                                    <!-- 段のプレビューがここに表示される -->
                                                </div>
                                                <div class="shelf-preview-stats mt-3">
                                                    <div class="row text-center">
                                                        <div class="col-4">
                                                            <small class="text-muted d-block">段数</small>
                                                            <strong id="segment-count">0</strong>
                                                        </div>
                                                        <div class="col-4">
                                                            <small class="text-muted d-block">総高さ</small>
                                                            <strong id="total-height">0cm</strong>
                                                        </div>
                                                        <div class="col-4">
                                                            <small class="text-muted d-block">平均段高</small>
                                                            <strong id="avg-height">0cm</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- フォームアクション -->
                    <div class="border-top pt-4 mt-4">
                        <div class="d-flex justify-content-between">
                            <div>
                                {% if object %}
                                    <a href="{% url 'shelves:detail' object.pk %}" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> キャンセル
                                    </a>
                                {% else %}
                                    <a href="{% url 'shelves:list' %}" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> キャンセル
                                    </a>
                                {% endif %}
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <i class="bi bi-check-lg"></i> {{ submit_text }}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.required::after {
    content: ' *';
    color: #dc3545;
}

.shelf-preview-container {
    border: 2px solid #dee2e6;
    border-radius: 0.375rem;
    background: #f8f9fa;
    padding: 1rem;
    min-height: 200px;
}

.shelf-preview-dimensions {
    text-align: center;
    font-weight: 600;
    color: #495057;
    margin-bottom: 1rem;
}

.shelf-segments-preview {
    min-height: 100px;
    border: 1px dashed #dee2e6;
    border-radius: 0.25rem;
    background: white;
    position: relative;
}

.preview-segment {
    border: 1px solid #adb5bd;
    background: linear-gradient(to right, #f8f9fa 0%, #ffffff 50%, #f8f9fa 100%);
    margin-bottom: 2px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: #495057;
    transition: all 0.2s ease;
}

.preview-segment:hover {
    background: linear-gradient(to right, #e3f2fd 0%, #f3f4f6 50%, #e3f2fd 100%);
    border-color: #0d6efd;
}

.preview-segment .segment-label {
    font-weight: 600;
}

.segment-form {
    padding: 12px;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.segment-form:hover {
    border-color: #0d6efd;
    background: white;
}

.segment-form.to-delete {
    background: #f8d7da;
    border-color: #dc3545;
    opacity: 0.6;
}

.shelf-preview-stats {
    padding: 0.75rem;
    background: white;
    border-radius: 0.25rem;
    border: 1px solid #e9ecef;
}

.alert-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let segmentIndex = {{ segment_formset.total_form_count }};

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    updateSegmentNumbers();
    
    // フォーム変更時にプレビューを更新
    document.querySelectorAll('#{{ form.width.id_for_label }}, #{{ form.depth.id_for_label }}').forEach(input => {
        input.addEventListener('input', updatePreview);
    });
    
    // 段の高さ変更時にプレビューを更新
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.includes('height')) {
            updatePreview();
        }
    });
});

// 段を追加
function addSegment() {
    const totalForms = document.getElementById('id_segments-TOTAL_FORMS');
    const formIndex = parseInt(totalForms.value);
    
    if (formIndex >= 10) {
        alert('最大10段まで作成できます');
        return;
    }
    
    const emptyForm = `
        <div class="segment-form mb-3" data-form-index="${formIndex}">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <strong>段${formIndex + 1}</strong>
                    <input type="hidden" name="segments-${formIndex}-level" value="${formIndex + 1}" id="id_segments-${formIndex}-level">
                </div>
                <div class="col">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">高さ</span>
                        <input type="number" name="segments-${formIndex}-height" step="0.1" min="0.1" placeholder="cm" class="form-control form-control-sm" id="id_segments-${formIndex}-height" value="30">
                        <span class="input-group-text">cm</span>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSegment(this)" title="削除">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <input type="hidden" name="segments-${formIndex}-id" id="id_segments-${formIndex}-id">
        </div>
    `;
    
    document.getElementById('segment-forms').insertAdjacentHTML('beforeend', emptyForm);
    totalForms.value = formIndex + 1;
    
    updatePreview();
    updateSegmentNumbers();
}

// 段を削除
function removeSegment(button) {
    const segmentForm = button.closest('.segment-form');
    const deleteField = segmentForm.querySelector('input[name$="-DELETE"]');
    
    if (deleteField) {
        // 既存の段の場合は削除フラグを設定
        toggleDelete(button);
    } else {
        // 新しい段の場合は要素を削除
        segmentForm.remove();
        updateTotalForms();
        updatePreview();
        updateSegmentNumbers();
    }
}

// 削除フラグの切り替え
function toggleDelete(button) {
    const segmentForm = button.closest('.segment-form');
    const deleteField = segmentForm.querySelector('input[name$="-DELETE"]');
    
    if (deleteField) {
        deleteField.checked = !deleteField.checked;
        segmentForm.classList.toggle('to-delete', deleteField.checked);
        
        const icon = button.querySelector('i');
        if (deleteField.checked) {
            icon.className = 'bi bi-arrow-clockwise';
            button.title = '削除を取り消し';
        } else {
            icon.className = 'bi bi-trash';
            button.title = '削除';
        }
        
        updatePreview();
    }
}

// 段をリセット
function resetSegments() {
    if (confirm('段設定をリセットしますか？')) {
        const segmentForms = document.getElementById('segment-forms');
        segmentForms.innerHTML = '';
        
        // デフォルトで4段を作成
        for (let i = 0; i < 4; i++) {
            addSegment();
        }
        
        updateTotalForms();
        updatePreview();
    }
}

// フォーム数を更新
function updateTotalForms() {
    const forms = document.querySelectorAll('.segment-form:not(.to-delete)');
    document.getElementById('id_segments-TOTAL_FORMS').value = forms.length;
}

// 段番号を更新
function updateSegmentNumbers() {
    const forms = document.querySelectorAll('.segment-form:not(.to-delete)');
    forms.forEach((form, index) => {
        const label = form.querySelector('strong');
        const levelInput = form.querySelector('input[name$="-level"]');
        if (label) label.textContent = `段${index + 1}`;
        if (levelInput) levelInput.value = index + 1;
    });
}

// プレビューを更新
function updatePreview() {
    const width = parseFloat(document.getElementById('{{ form.width.id_for_label }}').value) || 0;
    const depth = parseFloat(document.getElementById('{{ form.depth.id_for_label }}').value) || 0;
    
    // 寸法表示の更新
    document.getElementById('preview-width').textContent = width || '-';
    document.getElementById('preview-depth').textContent = depth || '-';
    
    // 段プレビューの更新
    const segmentsPreview = document.getElementById('shelf-segments-preview');
    segmentsPreview.innerHTML = '';
    
    const forms = document.querySelectorAll('.segment-form:not(.to-delete)');
    let totalHeight = 0;
    let validSegments = 0;
    
    forms.forEach((form, index) => {
        const heightInput = form.querySelector('input[name$="-height"]');
        const height = parseFloat(heightInput?.value) || 0;
        
        if (height > 0) {
            const segmentDiv = document.createElement('div');
            segmentDiv.className = 'preview-segment';
            segmentDiv.style.height = Math.max(height / 2, 20) + 'px'; // スケール調整
            segmentDiv.innerHTML = `<div class="segment-label">段${index + 1} (${height}cm)</div>`;
            
            segmentsPreview.appendChild(segmentDiv);
            totalHeight += height;
            validSegments++;
        }
    });
    
    // 統計の更新
    document.getElementById('segment-count').textContent = validSegments;
    document.getElementById('total-height').textContent = totalHeight.toFixed(1) + 'cm';
    document.getElementById('avg-height').textContent = validSegments > 0 ? (totalHeight / validSegments).toFixed(1) + 'cm' : '0cm';
    
    // プレビューが空の場合
    if (validSegments === 0) {
        segmentsPreview.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted"><i class="bi bi-layers me-2"></i>段を追加してください</div>';
    }
}

// フォーム送信時のローディング表示
document.querySelector('form').addEventListener('submit', function() {
    const submitBtn = document.getElementById('submit-btn');
    FlexiShelf.showLoading(submitBtn);
});

// バリデーション強化
document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('change', function() {
        const value = parseFloat(this.value);
        const min = parseFloat(this.min);
        const max = parseFloat(this.max);
        
        if (isNaN(value) || (min && value < min) || (max && value > max)) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
});
</script>
{% endblock %}